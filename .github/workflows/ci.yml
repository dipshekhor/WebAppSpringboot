name: CI/CD Pipeline

# TRIGGER: when does this pipeline run?
on:
  push:
    branches: [ "main", "master" ]   # every commit pushed to main/master
  pull_request:
    branches: [ "main", "master" ]   # every PR opened against main/master


# JOBS: the units of work that run (optionally in parallel)
jobs:

  # JOB 1 — test
  # Purpose: compile the code and run all 119 tests
  # Uses H2 in-memory DB (no PostgreSQL needed in CI)

  test:
    name: Build & Test
    runs-on: ubuntu-latest         # free GitHub-hosted Linux runner

    steps:

      # STEP 1 — Check out the repository code
      - name: Checkout source code
        uses: actions/checkout@v4

      # STEP 2 — Install Java 17 (matches pom.xml <java.version>17</java.version>)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'        # Eclipse Temurin (same image as Dockerfile)
          cache: 'maven'                 # cache ~/.m2 between runs → faster builds

      # STEP 3 — Make the Maven wrapper executable (Linux needs this)
      - name: Make mvnw executable
        run: chmod +x mvnw

      # STEP 4 — Compile and run all 119 tests
      # The tests use H2 (application-test.properties) so no real DB is needed.
      # spring.docker.compose.enabled=false prevents Docker Compose from starting.
      - name: Run unit and integration tests
        run: ./mvnw test --batch-mode --no-transfer-progress

      # STEP 5 — Upload the Surefire test reports as a downloadable artifact
      # so you can inspect failures even after the job finishes
      - name: Upload test reports
        if: always()                     # run even when tests fail
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: target/surefire-reports/
          retention-days: 7


  # JOB 2 — docker-build
  # Purpose: prove the Docker image builds successfully
  # Only runs AFTER job 1 passes (needs: test)
  # Only runs on push to main/master, NOT on pull requests
 
  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test                          # wait for job 1 to succeed
    if: github.event_name == 'push'      # skip on pull_request events

    steps:

      # STEP 1 — Check out source
      - name: Checkout source code
        uses: actions/checkout@v4

      # STEP 2 — Set up Docker Buildx (needed for multi-platform and cache support)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # STEP 3 — Build the Docker image using the project's Dockerfile
      # -DskipTests: tests already passed in job 1; no need to re-run here
      # The image is built but NOT pushed (no registry credentials configured).
      # To push to Docker Hub, add a docker/login-action step and set
      # push: true below, then add DOCKERHUB_USERNAME / DOCKERHUB_TOKEN secrets.
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false                    # build only, no push
          tags: sepm_assignment:latest
          build-args: |
            SKIP_TESTS=true
          cache-from: type=gha           # GitHub Actions cache layer
          cache-to: type=gha,mode=max
